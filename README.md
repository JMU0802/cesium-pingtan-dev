# 平潭三维场景可视化与多边形测量系统

## 🎯 项目简介

基于 Cesium 的平潭三维场景可视化系统，提供 3D Tiles 数据加载、多边形绘制与测量、面积统计等功能。支持多边形列表管理，可对每个多边形进行独立操作，包括高亮显示、编辑、删除等。

## 🚀 快速开始

### 启动服务器

```bash
npm start
```

服务器将在 `http://localhost:8080` 启动。

### 访问应用

浏览器访问：
- 主页面：`http://localhost:8080/index.html` （自动跳转到 pingtan-test.html）
- 直接访问：`http://localhost:8080/pingtan-test.html`

## 📦 主要功能

### 1. 三维场景加载
- 🌍 使用 OpenStreetMap 开源地图影像
- 🏔️ 椭球体地形模型（无需 Cesium Ion Token）
- 🏗️ 支持加载多个 3D Tiles 区块数据
  - BlockAB 区块
  - BlockXX 区块
  - BlockXA 区块
  - BlockAY 区块

### 2. 多边形绘制与编辑
- ✏️ **绘制模式**
  - 单击地图添加顶点
  - 实时预览绘制中的多边形（虚线显示）
  - 双击完成绘制（自动闭合多边形）
  - 随机颜色自动分配
  
- 🔧 **编辑模式**
  - 拖拽顶点调整多边形形状
  - Ctrl + 拖拽添加新顶点
  - 实时更新面积和周长
  - 保持多边形填充透明度

- 📊 **测量功能**
  - 自动计算多边形面积（平方米）
  - 自动计算多边形周长（米）
  - 面积换算为公顷/平方公里（大面积）

### 3. 多边形列表管理 ⭐
- 📋 **列表显示**
  - 自动编号显示所有多边形
  - 实时显示每个多边形的面积
  - 可滚动列表（最多显示 300px 高度）
  
- 🎯 **交互功能**
  - 点击列表项高亮对应多边形
  - 自动飞行到选中的多边形位置
  - 高亮时透明度增强（0.3 → 0.7）
  - 选中项背景高亮显示

- 🗑️ **删除功能**
  - 每个列表项都有删除按钮
  - 删除后自动更新总面积
  - 删除后自动重新编号

- 📈 **统计功能**
  - 显示所有多边形的总面积
  - 实时动态更新总面积
  - 绿色醒目标识总面积框

### 4. 文件操作
- 💾 **保存功能**
  - 导出为 JSON 格式
  - 保存所有多边形数据（包括 ID、名称、颜色、面积等）
  - 自动生成时间戳文件名
  
- 📂 **加载功能**
  - 从 JSON 文件恢复多边形
  - 保持原有颜色和属性
  - 自动计算并显示面积

### 5. 鼠标交互
- 📍 实时显示鼠标位置的经纬度坐标
- 🎨 坐标显示在页面左下角
- 🖱️ 拖拽旋转视角，滚轮缩放

## 🗂️ 项目结构

```
CesiumDev/
├── package.json          # 项目配置
├── server.js            # HTTP 服务器
├── start.bat           # Windows 启动脚本
├── src/
│   ├── index.html          # 入口页面（重定向）
│   ├── pingtan-test.html   # 主应用页面
│   ├── js/                 # JavaScript 模块
│   ├── styles/            # 样式文件
│   └── pingtan/           # Pingtan 3D 数据
│       └── terra_3Dtiles/ # 3D Tiles 数据
└── 安海澳测量数据/        # 测量数据存档
```

## 🛠️ 技术栈

- **Cesium.js** 1.95 - 三维地球引擎
- **OpenStreetMap** - 开源地图影像服务
- **http-server** - 轻量级开发服务器
- **原生 JavaScript** - 无额外框架依赖
- **Delaunator** - 多边形三角剖分（面积计算）

## 🎨 特色功能

### 多边形列表管理系统
本系统的核心特色是完善的多边形列表管理功能：

- ✅ **独立管理**：每个多边形独立存储，拥有唯一 ID
- ✅ **可视化列表**：清晰展示所有多边形信息
- ✅ **交互高亮**：点击列表项快速定位和高亮显示
- ✅ **灵活删除**：可单独删除任意多边形
- ✅ **实时统计**：动态计算和显示总面积
- ✅ **数据持久化**：支持保存和加载完整的多边形数据

### 精确面积计算
使用先进的三角剖分算法，精确计算任意形状多边形的面积：

- 支持凹多边形和凸多边形
- 自动单位换算（平方米/公顷/平方公里）
- 实时更新编辑时的面积变化

## 📝 使用说明

### 加载 3D 数据
1. 打开应用后会自动加载 OpenStreetMap 影像
2. 点击相应按钮加载不同区块的 3D Tiles 数据
3. 使用鼠标滚轮缩放，拖拽旋转视角
4. 点击"测试路径"检查数据文件是否存在

### 绘制多边形
1. 点击 **"开始绘制"** 按钮进入绘制模式
2. 在地图上 **单击** 添加顶点（会显示虚线预览）
3. **双击** 完成绘制，系统会自动：
   - 闭合多边形
   - 分配随机颜色
   - 计算面积和周长
   - 添加到多边形列表

### 编辑多边形
1. 点击 **"编辑多边形"** 按钮进入编辑模式
2. 直接 **拖拽顶点** 调整位置
3. **Ctrl + 拖拽** 在线段上添加新顶点
4. 面积和周长会实时更新
5. 点击 **"完成编辑"** 退出编辑模式

### 管理多边形列表
1. **查看列表**
   - 右侧面板显示所有已绘制的多边形
   - 每个多边形显示编号和面积

2. **高亮显示**
   - 点击列表项，对应多边形会高亮显示
   - 视角自动飞行到该多边形位置
   - 高亮的多边形透明度会增强

3. **删除多边形**
   - 点击列表项右侧的 **"删除"** 按钮
   - 该多边形会从场景和列表中移除
   - 总面积自动更新

4. **查看总面积**
   - 列表底部绿色框显示所有多边形的总面积
   - 删除或添加多边形时自动更新

### 保存与加载
1. **保存数据**
   - 点击 **"保存多边形"** 按钮
   - 自动生成 JSON 文件（带时间戳）
   - 保存所有多边形的完整信息

2. **加载数据**
   - 点击 **"加载多边形"** 按钮
   - 选择之前保存的 JSON 文件
   - 所有多边形将被恢复到场景中

### 其他功能
- **清除所有多边形**：点击"清空多边形"按钮
- **查看坐标**：移动鼠标即可在左下角查看经纬度
- **切换底图**：可在设置中切换不同的影像源

## ⚙️ 开发命令

```bash
# 安装依赖
npm install

# 启动开发服务器
npm start

# 或者直接使用 Python（无需安装 Node.js）
python -m http.server 8080
```

## 📋 注意事项

### 3D 数据文件
- 本项目的 3D Tiles 数据文件（`src/pingtan/`）未包含在 Git 仓库中
- 数据文件总大小约 2.22 GB，包含 BlockAB、BlockXX、BlockXA、BlockAY 四个区块
- 需要将 3D 数据文件放置在 `src/pingtan/terra_3Dtiles/` 目录下
- 支持的数据格式：`.b3dm`、`.json`（tileset）

### Cesium Ion Token
- 本项目使用开源地图服务，无需 Cesium Ion Token
- 如需使用 Cesium Ion 的高级功能，请访问 https://cesium.com/ion/ 获取 Token

### 浏览器兼容性
- 推荐使用现代浏览器（Chrome、Edge、Firefox）
- 需要支持 WebGL 2.0
- 建议使用较新版本的浏览器以获得最佳性能

## 🚀 部署说明

### 本地开发
```bash
npm start
# 访问 http://localhost:8080/src/pingtan-test.html
```

### 生产部署
1. 将整个 `src` 目录部署到 Web 服务器
2. 确保 3D 数据文件已正确放置
3. 配置 CORS 头（如果需要跨域访问）
4. 推荐使用 HTTPS 协议以获得更好的性能

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系方式

如有问题或建议，请通过 GitHub Issues 联系。

---

**版本**: 2.0.0  
**最后更新**: 2026年1月22日  
**主要更新**：
- ✨ 新增多边形列表管理功能
- ✨ 新增多边形高亮显示和飞行定位
- ✨ 新增总面积统计功能
- ✨ 新增单个多边形删除功能
- 🔧 优化多边形编辑体验
- 🔧 改用开源地图服务，移除 Token 依赖
